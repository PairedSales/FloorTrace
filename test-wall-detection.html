<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wall Detection Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    .controls {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 4px;
    }
    .control-group {
      margin: 10px 0;
    }
    label {
      display: inline-block;
      width: 150px;
      font-weight: bold;
    }
    input[type="number"] {
      width: 100px;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .results {
      margin-top: 20px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 4px;
      border-left: 4px solid #4CAF50;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-top: 5px;
    }
    .visualizations {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .viz-card {
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    .viz-header {
      background: #4CAF50;
      color: white;
      padding: 10px;
      font-weight: bold;
    }
    .viz-content {
      padding: 10px;
      text-align: center;
      background: white;
    }
    .viz-content img {
      max-width: 100%;
      height: auto;
      border: 1px solid #ddd;
    }
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      border-left: 4px solid #c62828;
    }
    .success {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      border-left: 4px solid #2e7d32;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèóÔ∏è Wall Detection System Test</h1>
    
    <div class="controls">
      <h3>Test Configuration</h3>
      
      <div class="control-group">
        <label for="minWallLength">Min Wall Length:</label>
        <input type="number" id="minWallLength" value="100" min="10" max="500" step="10">
        <span style="color: #666; font-size: 12px;">pixels (walls shorter than this are considered text/symbols)</span>
      </div>
      
      <div class="control-group">
        <label for="imageFile">Test Image:</label>
        <input type="file" id="imageFile" accept="image/*">
        <span style="color: #666; font-size: 12px;">or use default ExampleFloorplan.png</span>
      </div>
      
      <div style="margin-top: 15px;">
        <button id="runTest">Run Wall Detection Test</button>
        <button id="compareParams">Compare Parameters (50-150)</button>
        <button id="exportResults">Export Results</button>
      </div>
    </div>
    
    <div id="results" class="results"></div>
  </div>

  <script type="module">
    import { testWallDetection, compareWallDetectionParameters, exportTestResults } from './src/utils/wallDetectorTest.js';

    let currentResults = null;

    // Load default image
    async function loadDefaultImage() {
      const response = await fetch('./ExampleFloorplan.png');
      const blob = await response.blob();
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }

    // Get current image (from file input or default)
    async function getCurrentImage() {
      const fileInput = document.getElementById('imageFile');
      if (fileInput.files.length > 0) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.readAsDataURL(fileInput.files[0]);
        });
      }
      return loadDefaultImage();
    }

    // Display results
    function displayResults(results) {
      const resultsDiv = document.getElementById('results');
      
      let html = '';

      // Success/Error message
      if (results.success && results.errors.length === 0) {
        html += `<div class="success">‚úì Wall detection completed successfully in ${results.detectionTime}</div>`;
      } else if (results.errors.length > 0) {
        html += `<div class="error">‚ö† Wall detection completed with errors:<br>${results.errors.join('<br>')}</div>`;
      }

      // Statistics
      html += '<h3>Detection Statistics</h3>';
      html += '<div class="stats">';
      html += `<div class="stat-card"><div class="stat-label">Total Walls</div><div class="stat-value">${results.statistics.totalWalls}</div></div>`;
      html += `<div class="stat-card"><div class="stat-label">Horizontal</div><div class="stat-value">${results.statistics.horizontalWalls}</div></div>`;
      html += `<div class="stat-card"><div class="stat-label">Vertical</div><div class="stat-value">${results.statistics.verticalWalls}</div></div>`;
      html += `<div class="stat-card"><div class="stat-label">Exterior</div><div class="stat-value">${results.statistics.exteriorWalls}</div></div>`;
      html += `<div class="stat-card"><div class="stat-label">Interior</div><div class="stat-value">${results.statistics.interiorWalls}</div></div>`;
      html += `<div class="stat-card"><div class="stat-label">Perimeter Vertices</div><div class="stat-value">${results.statistics.perimeterVertices}</div></div>`;
      html += '</div>';

      // Perimeter test results
      if (results.perimeterTest) {
        html += '<h3>Perimeter Quality Test</h3>';
        if (results.perimeterTest.passed) {
          html += '<div class="success">‚úì Perimeter test passed</div>';
        } else {
          html += '<div class="error">‚úó Perimeter test failed</div>';
        }
        if (results.perimeterTest.warnings.length > 0) {
          html += `<div style="background: #fff3cd; padding: 10px; margin: 10px 0; border-radius: 4px;">`;
          html += `<strong>Warnings:</strong><ul>`;
          results.perimeterTest.warnings.forEach(w => html += `<li>${w}</li>`);
          html += `</ul></div>`;
        }
      }

      // Visualizations
      if (results.visualizations) {
        html += '<h3>Visualizations</h3>';
        html += '<div class="visualizations">';
        
        if (results.visualizations.combined) {
          html += `<div class="viz-card">
            <div class="viz-header">Combined View (All Walls + Perimeter)</div>
            <div class="viz-content"><img src="${results.visualizations.combined}" alt="Combined"></div>
          </div>`;
        }
        
        if (results.visualizations.allWalls) {
          html += `<div class="viz-card">
            <div class="viz-header">All Detected Walls</div>
            <div class="viz-content"><img src="${results.visualizations.allWalls}" alt="All Walls"></div>
          </div>`;
        }
        
        if (results.visualizations.exteriorWalls) {
          html += `<div class="viz-card">
            <div class="viz-header">Exterior Walls</div>
            <div class="viz-content"><img src="${results.visualizations.exteriorWalls}" alt="Exterior Walls"></div>
          </div>`;
        }
        
        if (results.visualizations.interiorWalls) {
          html += `<div class="viz-card">
            <div class="viz-header">Interior Walls</div>
            <div class="viz-content"><img src="${results.visualizations.interiorWalls}" alt="Interior Walls"></div>
          </div>`;
        }
        
        if (results.visualizations.perimeter) {
          html += `<div class="viz-card">
            <div class="viz-header">Perimeter Only</div>
            <div class="viz-content"><img src="${results.visualizations.perimeter}" alt="Perimeter"></div>
          </div>`;
        }
        
        html += '</div>';
      }

      resultsDiv.innerHTML = html;
    }

    // Display comparison results
    function displayComparisonResults(results) {
      const resultsDiv = document.getElementById('results');
      
      let html = '<h3>Parameter Comparison Results</h3>';
      html += '<p>Testing different minWallLength values to find optimal settings:</p>';
      
      html += '<table style="width: 100%; border-collapse: collapse; margin: 20px 0;">';
      html += '<thead><tr style="background: #4CAF50; color: white;">';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">Min Length</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">Total Walls</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">Horizontal</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">Vertical</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">Exterior</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">Interior</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">Perimeter Vertices</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">Test Passed</th>';
      html += '<th style="padding: 10px; border: 1px solid #ddd;">Errors</th>';
      html += '</tr></thead><tbody>';
      
      results.forEach((r, idx) => {
        const s = r.statistics;
        const bgColor = idx % 2 === 0 ? '#f9f9f9' : 'white';
        html += `<tr style="background: ${bgColor};">`;
        html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;"><strong>${r.minWallLength}</strong></td>`;
        html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${s.totalWalls}</td>`;
        html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${s.horizontalWalls}</td>`;
        html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${s.verticalWalls}</td>`;
        html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${s.exteriorWalls}</td>`;
        html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${s.interiorWalls}</td>`;
        html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${s.perimeterVertices}</td>`;
        html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${r.perimeterPassed ? '‚úì' : '‚úó'}</td>`;
        html += `<td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${r.errors}</td>`;
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      
      // Recommendation
      const bestResult = results.find(r => r.perimeterPassed && r.errors === 0) || results[0];
      html += `<div class="success">üí° <strong>Recommendation:</strong> Based on the tests, minWallLength = ${bestResult.minWallLength} appears to work best for this image.</div>`;
      
      resultsDiv.innerHTML = html;
    }

    // Run test button
    document.getElementById('runTest').addEventListener('click', async () => {
      const button = document.getElementById('runTest');
      const resultsDiv = document.getElementById('results');
      
      try {
        button.disabled = true;
        resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Running wall detection test...</p></div>';
        
        const imageDataUrl = await getCurrentImage();
        const minWallLength = parseInt(document.getElementById('minWallLength').value);
        
        currentResults = await testWallDetection(imageDataUrl, {
          minWallLength,
          testPerimeter: true,
          showDebugInfo: true
        });
        
        displayResults(currentResults);
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        console.error('Test error:', error);
      } finally {
        button.disabled = false;
      }
    });

    // Compare parameters button
    document.getElementById('compareParams').addEventListener('click', async () => {
      const button = document.getElementById('compareParams');
      const resultsDiv = document.getElementById('results');
      
      try {
        button.disabled = true;
        resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Running parameter comparison (this may take a minute)...</p></div>';
        
        const imageDataUrl = await getCurrentImage();
        const comparisonResults = await compareWallDetectionParameters(imageDataUrl, [50, 75, 100, 125, 150]);
        
        displayComparisonResults(comparisonResults);
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        console.error('Comparison error:', error);
      } finally {
        button.disabled = false;
      }
    });

    // Export results button
    document.getElementById('exportResults').addEventListener('click', () => {
      if (currentResults) {
        exportTestResults(currentResults);
      } else {
        alert('No results to export. Run a test first.');
      }
    });

    // Auto-run test on page load with default image
    window.addEventListener('load', () => {
      document.getElementById('runTest').click();
    });
  </script>
</body>
</html>
